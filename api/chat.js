
/*
  ========================================================================================
  ü§ñ API: Gemini AI Wedding Concierge
  ========================================================================================
  
  [Persona]
  - Natthamonpisit (Ouk): ‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß (‡∏™‡∏∏‡∏†‡∏≤‡∏û, ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£)
  - Sorot (Bew): ‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß (‡∏™‡∏î‡πÉ‡∏™, ‡∏Ç‡∏µ‡πâ‡πÄ‡∏•‡πà‡∏ô)
  - ‡πÅ‡∏°‡∏ß 3 ‡∏ï‡∏±‡∏ß: ‡∏Å‡πâ‡∏≠‡∏ô (‡∏™‡πâ‡∏°), ‡∏Å‡∏•‡∏° (‡πÄ‡∏ó‡∏≤), ‡∏Å‡∏∂‡πã‡∏¢ (‡∏î‡∏≥)
  
  [Capabilities]
  - ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á (Date, Location, Schedule)
  - ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢ Google Search
  - ‡∏´‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Google Maps
*/

import { GoogleGenAI } from "@google/genai";

export default async function handler(req, res) {
  // CORS Handling
  res.setHeader('Access-Control-Allow-Credentials', true);
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET,OPTIONS,PATCH,DELETE,POST,PUT');
  res.setHeader(
    'Access-Control-Allow-Headers',
    'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version'
  );

  if (req.method === 'OPTIONS') {
    res.status(200).end();
    return;
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  // Helper Function: Fetch Image URL and convert to Base64 for Gemini
  async function urlToGenerativePart(url) {
    try {
      const response = await fetch(url);
      if (!response.ok) {
        console.warn(`Failed to fetch image: ${response.statusText}`);
        return null;
      }
      const arrayBuffer = await response.arrayBuffer();
      return {
        inlineData: {
          data: Buffer.from(arrayBuffer).toString("base64"),
          mimeType: response.headers.get("content-type") || "image/jpeg",
        },
      };
    } catch (error) {
      console.error("Error converting image:", error);
      return null;
    }
  }

  try {
    const { message, history, image } = req.body;

    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
    
    // -------------------------------------------------------------------------
    // üìù SYSTEM INSTRUCTION: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï AI (Persona & Scope)
    // -------------------------------------------------------------------------
    const systemInstruction = `
      ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "AI ‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏π‡πà‡∏ö‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏ß" (Virtual Natthamonpisit & Sorot) 
      ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏Ç‡∏Å‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß‡∏ô‡∏±‡πà‡∏á‡∏ï‡∏≠‡∏ö‡πÅ‡∏ä‡∏ó‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ
      
      **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (Persona Identifiers):**
      1. **Natthamonpisit (‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß):** ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô **"‡∏≠‡∏∏‡πä‡∏Å" (Ouk)**
      2. **Sorot (‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß):** ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô **"‡∏ö‡∏¥‡∏ß" (Bew)**
      *‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏´‡∏≤‡∏Å User ‡∏ñ‡∏≤‡∏°‡∏ñ‡∏∂‡∏á "‡∏≠‡∏∏‡πä‡∏Å", "‡∏û‡∏µ‡πà‡∏≠‡∏∏‡πä‡∏Å", "Ouk" ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß ‡πÅ‡∏•‡∏∞ "‡∏ö‡∏¥‡∏ß", "‡∏û‡∏µ‡πà‡∏ö‡∏¥‡∏ß", "Bew" ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß*

      **‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÅ‡∏°‡∏ß‡πÄ‡∏´‡∏°‡∏µ‡∏¢‡∏ß (The Cats):**
      ‡πÉ‡∏ô‡∏£‡∏π‡∏õ Profile ‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ ‡∏à‡∏∞‡∏°‡∏µ‡πÅ‡∏°‡∏ß 3 ‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡∏≤‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö:
      1. **"‡∏Å‡πâ‡∏≠‡∏ô" (Gon):** ‡∏û‡∏µ‡πà‡∏Ñ‡∏ô‡πÇ‡∏ï ‡∏ï‡∏±‡∏ß‡∏™‡∏µ‡∏™‡πâ‡∏°
      2. **"‡∏Å‡∏•‡∏°" (Glom):** ‡∏ô‡πâ‡∏≠‡∏á‡∏Ñ‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡∏ï‡∏±‡∏ß‡∏™‡∏µ‡πÄ‡∏ó‡∏≤
      3. **"‡∏Å‡∏∂‡πã‡∏¢" (Gui):** ‡∏ô‡πâ‡∏≠‡∏á‡∏Ñ‡∏ô‡πÄ‡∏•‡πá‡∏Å ‡∏ï‡∏±‡∏ß‡∏™‡∏µ‡∏î‡∏≥ (‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏≤‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡∏≠‡∏¢‡∏π‡πà)
      *‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏ó‡∏±‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏π‡∏õ Profile ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡πÅ‡∏°‡∏ß ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ô‡πâ‡∏≠‡∏á‡πÜ ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢*

      **‡∏Å‡∏è‡πÄ‡∏´‡∏•‡πá‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (Strict Guidelines):**
      1. **‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ß (No Hallucination):** ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô, ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô, ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏°‡∏ß **‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô** ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ "‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏û‡∏ß‡∏Å‡πÄ‡∏£‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏Ç‡∏≠‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏°‡∏≤‡∏ö‡∏≠‡∏Å‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡∏∞" (‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏≠‡∏á‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î)
      2. **General Topics:** ‡∏´‡∏≤‡∏Å User ‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏î‡∏¥‡∏ô‡∏ü‡πâ‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏®, ‡∏Ç‡πà‡∏≤‡∏ß, ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ) ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏£‡∏¢‡∏≤‡∏ó ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° **‡πÇ‡∏¢‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô** ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•
      3. **Format:** ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏£‡∏ß‡∏ö‡∏û‡∏≤‡∏£‡∏≤‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î "Natthamonpisit:" ‡πÅ‡∏•‡∏∞ "Sorot:" ‡πÄ‡∏™‡∏°‡∏≠

      **Character Voice (‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏ï‡∏±‡∏ß):**
      üßîüèª‚Äç‚ôÇÔ∏è **Natthamonpisit (‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß - ‡∏≠‡∏∏‡πä‡∏Å):** 
      - **‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏ï‡∏±‡∏ß:** "‡∏≠‡∏∏‡πä‡∏Å" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ú‡∏°"
      - ‡∏™‡πÑ‡∏ï‡∏•‡πå: ‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
      - ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢: "‡∏Ñ‡∏£‡∏±‡∏ö", "‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö"
      
      üë©üèª **Sorot (‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß - ‡∏ö‡∏¥‡∏ß):** 
      - **‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏ï‡∏±‡∏ß:** "‡∏ö‡∏¥‡∏ß"
      - ‡∏™‡πÑ‡∏ï‡∏•‡πå: ‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á ‡∏™‡∏î‡πÉ‡∏™ ‡∏Ç‡∏µ‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ô‡∏¥‡∏î‡πÜ ‡πÉ‡∏™‡πà‡πÉ‡∏à‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
      - ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢: "‡∏Ñ‡πà‡∏∞", "‡∏ô‡∏∞‡∏Ñ‡∏∞", "‡∏Ñ‡πà‡∏≤"

      **Information & Tools:**
      - ‡∏á‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏ó‡∏µ‡πà: "Dalva le ville", Bangkok (‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏µ‡πà 21 ‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏° 2026)
      - **‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©:** ‡∏´‡∏≤‡∏Å‡∏ñ‡∏≤‡∏° "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà", "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà", "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏á" -> ‡πÉ‡∏ä‡πâ Google Maps ‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î Dalva le ville ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö Link
      - **‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:** ‡∏´‡∏≤‡∏Å‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å -> ‡πÉ‡∏ä‡πâ Google Search

      **Knowledge Base (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô):**
      - ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏µ‡πà 21 ‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏° 2026
      - ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: Dalva le ville, Bangkok
      - ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£: 07:00 ‡∏ï‡∏±‡∏Å‡∏ö‡∏≤‡∏ï‡∏£, 09:00 ‡∏´‡∏°‡∏±‡πâ‡∏ô, 11:00 ‡∏â‡∏•‡∏≠‡∏á‡∏°‡∏á‡∏Ñ‡∏•‡∏™‡∏°‡∏£‡∏™
    `;

    // Construct chat history for context
    const chatHistory = (history || []).slice(-10).map(msg => ({
      role: msg.role === 'user' ? 'user' : 'model',
      parts: [{ text: msg.content }]
    }));

    const chat = ai.chats.create({
      model: 'gemini-2.5-flash',
      config: {
        systemInstruction: systemInstruction,
        temperature: 0.7,
        // Enable Google Search and Google Maps Grounding
        tools: [
          { googleSearch: {} }, 
          { googleMaps: {} }
        ],
      },
      history: chatHistory
    });

    // Prepare content parts
    let contentParts = [];
    
    // 1. If image URL is provided (e.g. from Cloudinary), convert to Base64 for Gemini
    if (image) {
      const imagePart = await urlToGenerativePart(image);
      if (imagePart) {
        contentParts.push(imagePart);
      }
    }

    // 2. Add text message
    contentParts.push({ text: message });

    // Send to Gemini (Pass array of parts)
    const result = await chat.sendMessage(contentParts);
    let responseText = result.text;

    // -------------------------------------------------------------------------
    // üó∫Ô∏è GROUNDING METADATA EXTRACTION
    // ‡∏î‡∏∂‡∏á Link ‡∏à‡∏≤‡∏Å Google Search / Maps ‡∏°‡∏≤‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏ï‡∏≤‡∏°‡∏Å‡∏è Google GenAI SDK)
    // -------------------------------------------------------------------------
    const groundingMetadata = result.candidates?.[0]?.groundingMetadata;
    const links = [];

    if (groundingMetadata?.groundingChunks) {
      groundingMetadata.groundingChunks.forEach(chunk => {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô Web Search
        if (chunk.web?.uri) {
          links.push(chunk.web.uri);
        }
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô Maps
        if (chunk.maps?.uri) {
          links.push(chunk.maps.uri);
        }
      });
    }

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Link ‡πÉ‡∏´‡∏°‡πà‡πÜ ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
    if (links.length > 0) {
      const uniqueLinks = [...new Set(links)];
      const newLinks = uniqueLinks.filter(link => !responseText.includes(link));
      
      if (newLinks.length > 0) {
        responseText += "\n\nüìç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° & ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà:\n" + newLinks.join("\n");
      }
    }

    return res.status(200).json({ reply: responseText });

  } catch (error) {
    console.error("AI Error:", error);
    return res.status(500).json({ error: "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏ß‡∏Å‡πÄ‡∏£‡∏≤‡∏™‡∏∞‡∏î‡∏∏‡∏î‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏£‡∏µ‡∏ö‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö" });
  }
}
