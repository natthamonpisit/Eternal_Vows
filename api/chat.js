import { GoogleGenAI } from "@google/genai";

export default async function handler(req, res) {
  // CORS Handling
  res.setHeader('Access-Control-Allow-Credentials', true);
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET,OPTIONS,PATCH,DELETE,POST,PUT');
  res.setHeader(
    'Access-Control-Allow-Headers',
    'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version'
  );

  if (req.method === 'OPTIONS') {
    res.status(200).end();
    return;
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { message, history } = req.body;

    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
    
    // -------------------------------------------------------------------------
    // SYSTEM INSTRUCTION: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï AI (Persona & Scope)
    // -------------------------------------------------------------------------
    const systemInstruction = `
      ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "AI ‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏π‡πà‡∏ö‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏ß" (Virtual Natthamonpisit & Sorot) 
      ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏Ç‡∏Å‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß‡∏ô‡∏±‡πà‡∏á‡∏ï‡∏≠‡∏ö‡πÅ‡∏ä‡∏ó‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ
      
      **‡∏Å‡∏è‡πÄ‡∏´‡∏•‡πá‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Format (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î):**
      1. **‡∏´‡πâ‡∏≤‡∏°** ‡∏ï‡∏≠‡∏ö‡∏£‡∏ß‡∏ö‡∏¢‡∏≠‡∏î‡∏û‡∏≤‡∏£‡∏≤‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      2. **‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î** ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡∏ô‡∏û‡∏π‡∏î‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
      3. ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ **‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏û‡∏π‡∏î**: "Natthamonpisit:" ‡πÅ‡∏•‡∏∞ "Sorot:"
      4. **‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ** ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏π‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πà‡∏≠‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤
      
      **Character Voice:**
      üßîüèª‚Äç‚ôÇÔ∏è **Natthamonpisit (‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß):** 
      - ‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà, ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á)
      - ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢: "‡∏Ñ‡∏£‡∏±‡∏ö", "‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö" (‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ‡∏Ñ‡πà‡∏∞)
      
      üë©üèª **Sorot (‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß):** 
      - ‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á ‡∏™‡∏î‡πÉ‡∏™ ‡πÉ‡∏™‡πà‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å (‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ò‡∏µ‡∏°‡∏ä‡∏∏‡∏î, ‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°)
      - ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢: "‡∏Ñ‡πà‡∏∞", "‡∏ô‡∏∞‡∏Ñ‡∏∞", "‡∏Ñ‡πà‡∏≤" (‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ‡∏Ñ‡∏£‡∏±‡∏ö)

      **Information & Tools:**
      - ‡∏á‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏ó‡∏µ‡πà: "Dalva le ville", Bangkok (‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏µ‡πà 21 ‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏° 2026)
      - **‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©:** ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà", "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà", "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏á" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏à‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô" **‡∏ï‡πâ‡∏≠‡∏á**‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ Google Maps ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á "Dalva le ville" ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö Link ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏Ç‡∏Å‡πÄ‡∏™‡∏°‡∏≠
      - **‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:** ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Google Search ‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢

      **Knowledge Base (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô):**
      - ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏µ‡πà 21 ‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏° 2026
      - ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: Dalva le ville, Bangkok
      - ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£: 07:00 ‡∏ï‡∏±‡∏Å‡∏ö‡∏≤‡∏ï‡∏£, 09:00 ‡∏´‡∏°‡∏±‡πâ‡∏ô, 11:00 ‡∏â‡∏•‡∏≠‡∏á‡∏°‡∏á‡∏Ñ‡∏•‡∏™‡∏°‡∏£‡∏™
      
      **Note:** 
      - ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô
      - ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ Link ‡∏à‡∏≤‡∏Å Google Maps ‡∏´‡∏£‡∏∑‡∏≠ Search ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏ö‡∏°‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢
    `;

    // Construct chat history for context
    const chatHistory = (history || []).slice(-10).map(msg => ({
      role: msg.role === 'user' ? 'user' : 'model',
      parts: [{ text: msg.content }]
    }));

    const chat = ai.chats.create({
      model: 'gemini-2.5-flash',
      config: {
        systemInstruction: systemInstruction,
        temperature: 0.8,
        // Enable Google Search and Google Maps Grounding
        tools: [
          { googleSearch: {} }, 
          { googleMaps: {} }
        ],
      },
      history: chatHistory
    });

    const result = await chat.sendMessage({ message: message });
    let responseText = result.text;

    // -------------------------------------------------------------------------
    // GROUNDING METADATA EXTRACTION
    // ‡∏î‡∏∂‡∏á Link ‡∏à‡∏≤‡∏Å Google Search / Maps ‡∏°‡∏≤‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏ï‡∏≤‡∏°‡∏Å‡∏è Google GenAI SDK)
    // -------------------------------------------------------------------------
    const groundingMetadata = result.candidates?.[0]?.groundingMetadata;
    const links = [];

    if (groundingMetadata?.groundingChunks) {
      groundingMetadata.groundingChunks.forEach(chunk => {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô Web Search
        if (chunk.web?.uri) {
          links.push(chunk.web.uri);
        }
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô Maps
        if (chunk.maps?.uri) {
          links.push(chunk.maps.uri);
        }
      });
    }

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Link ‡πÉ‡∏´‡∏°‡πà‡πÜ ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
    if (links.length > 0) {
      const uniqueLinks = [...new Set(links)];
      const newLinks = uniqueLinks.filter(link => !responseText.includes(link));
      
      if (newLinks.length > 0) {
        responseText += "\n\nüìç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° & ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà:\n" + newLinks.join("\n");
      }
    }

    return res.status(200).json({ reply: responseText });

  } catch (error) {
    console.error("AI Error:", error);
    return res.status(500).json({ error: "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏ß‡∏Å‡πÄ‡∏£‡∏≤‡∏™‡∏∞‡∏î‡∏∏‡∏î‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏£‡∏µ‡∏ö‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö" });
  }
}